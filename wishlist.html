<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wishlist - iGameDB</title>
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="js/rawg-api.js"></script>
    <script src="js/auth-service.js"></script>
</head>
<body>
    <div id="header" class="header">
        <a href="index.html">        
            <img src="images/iGameDB.png" alt="iGameDB Logo">
        </a>
        <div class="search-bar">
            <form onsubmit="handleSearch(event)">
                <input type="text" placeholder="Search..." aria-label="Search games" id="searchInput">
            </form>
        </div>
        <button id="menuToggle" class="menu-toggle" aria-expanded="false" aria-controls="navMenu">☰</button>

        <nav id="navMenu" class="nav-buttons">
            <a href="wishlist.html" class="wishlist active">Wishlist</a>
            <span id="authButtons">
                <a href="signin.html" class="sign-in">Sign In</a>
            </span>
            <span id="userButtons" style="display: none;">
                <span id="userGreeting" class="user-greeting" style="color: white; font-size: 14px; margin-right: 10px;"></span>
                <button onclick="handleLogout()" class="sign-in" style="background-color: #ff6b6b; border: none;">Logout</button>
            </span>
            <a href="about_us.html" class="about-link">About Us</a>

            <div class="settings">
                <button id="settingsToggle" class="settings-btn" aria-expanded="false" aria-controls="settingsMenu">☰</button>
                <div id="settingsMenu" class="settings-menu" hidden>
                    <label class="setting"><span>Header fixed</span><button type="button" id="headerFixed" class="toggle-btn" aria-pressed="false"></button></label>
                    <label class="setting"><span>Light mode</span><button type="button" id="lightMode" class="toggle-btn" aria-pressed="false"></button></label>
                    <button id="resetSettings" class="reset-btn">Reset</button>
                </div>
            </div>
        </nav>
    </div>
    
    <div class="container">
        <section class="wishlist-section">
            <h2>MY WISHLIST</h2>
            <div class="game-grid" id="wishlistGrid">
                <div class="loading">Loading wishlist...</div>
            </div>
        </section>
    </div>

    <footer class="footer">
        <a href="index.html">        
            <img src="images/iGameDB.png" alt="iGameDB Logo">
        </a>

        <div class="footer-buttons">
            <button class="about" onclick="window.location.href='about_us.html'">About Us</button><br>
            <button class="follow">Follow Us</button>
        </div>
    </footer>

    <script src="js/auth-service.js"></script>
    <script>
    if(!window._igdb_header_init){
        window._igdb_header_init = true;
        if(!window.handleSearch) window.handleSearch = function(event){ event.preventDefault(); const input = document.getElementById('searchInput'); if(!input) return; const query = input.value; if(query.trim()) window.location.href = 'searched_for.html?q='+encodeURIComponent(query); };
        if(!window.handleLogout) window.handleLogout = async function(){ if(confirm('Are you sure you want to logout?')){ if(window.authService && authService.logout) await authService.logout(); } };
        if(!window.updateAuthUI) window.updateAuthUI = async function(){ if(!window.authService) return; try{ const user = await authService.getCurrentUser(); if(user){ const ab = document.getElementById('authButtons'); const ub = document.getElementById('userButtons'); if(ab) ab.style.display='none'; if(ub) ub.style.display='inline-block'; } }catch(e){} };
        document.addEventListener('DOMContentLoaded', ()=>{ if(window.authService && authService.handleLoginCallback) authService.handleLoginCallback(); if(window.updateAuthUI) updateAuthUI(); });

        (function(){
            const settingsToggle = document.getElementById('settingsToggle');
            const settingsMenu = document.getElementById('settingsMenu');
            const headerFixedCB = document.getElementById('headerFixed');
            const lightModeCB = document.getElementById('lightMode');
            const resetBtn = document.getElementById('resetSettings');
            const headerEl = document.getElementById('header');
            if(!settingsToggle || !settingsMenu) return;
            function applyHeaderFixed(enabled){ if(!headerEl) return; headerEl.className = enabled ? 'header-fixed' : 'header'; }
            function applyLightMode(enabled){ document.documentElement.classList.toggle('light-mode', enabled); }
            function save(){ if(!headerFixedCB || !lightModeCB) return; localStorage.setItem('igdb_headerFixed', headerFixedCB.getAttribute('aria-pressed')==='true' ? '1':'0'); localStorage.setItem('igdb_lightMode', lightModeCB.getAttribute('aria-pressed')==='true' ? '1':'0'); }
            function load(){ if(!headerFixedCB || !lightModeCB) return; const hf = localStorage.getItem('igdb_headerFixed')==='1'; const lm = localStorage.getItem('igdb_lightMode')==='1'; headerFixedCB.setAttribute('aria-pressed', hf ? 'true':'false'); lightModeCB.setAttribute('aria-pressed', lm ? 'true':'false'); applyHeaderFixed(hf); applyLightMode(lm); }
            settingsToggle.addEventListener('click', ()=>{ const isHidden = settingsMenu.hasAttribute('hidden'); if(isHidden){ settingsMenu.removeAttribute('hidden'); settingsToggle.setAttribute('aria-expanded','true'); } else { settingsMenu.setAttribute('hidden',''); settingsToggle.setAttribute('aria-expanded','false'); } });
            document.addEventListener('click',(e)=>{ if(!settingsMenu.contains(e.target) && e.target !== settingsToggle){ settingsMenu.setAttribute('hidden',''); settingsToggle.setAttribute('aria-expanded','false'); } });
            if(headerFixedCB) headerFixedCB.addEventListener('click', ()=>{ const isPressed = headerFixedCB.getAttribute('aria-pressed')==='true'; headerFixedCB.setAttribute('aria-pressed', !isPressed); applyHeaderFixed(!isPressed); save(); });
            if(lightModeCB) lightModeCB.addEventListener('click', ()=>{ const isPressed = lightModeCB.getAttribute('aria-pressed')==='true'; lightModeCB.setAttribute('aria-pressed', !isPressed); applyLightMode(!isPressed); save(); });
            if(resetBtn) resetBtn.addEventListener('click', ()=>{ localStorage.removeItem('igdb_headerFixed'); localStorage.removeItem('igdb_lightMode'); if(headerFixedCB) headerFixedCB.setAttribute('aria-pressed','false'); if(lightModeCB) lightModeCB.setAttribute('aria-pressed','false'); applyHeaderFixed(false); applyLightMode(false); });
            window.addEventListener('resize', ()=>{ if(headerEl && headerEl.classList.contains('header-fixed')) document.body.style.paddingTop = headerEl.offsetHeight + 'px'; });
            if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', load); else load();
        })();
        (function(){
            const menuToggle = document.getElementById('menuToggle');
            const navMenu = document.getElementById('navMenu');
            if(!menuToggle || !navMenu) return;
            menuToggle.addEventListener('click', (e)=>{ e.stopPropagation(); const isOpen = navMenu.classList.toggle('open'); menuToggle.setAttribute('aria-expanded', isOpen ? 'true' : 'false'); });
            document.addEventListener('click',(e)=>{ if(!navMenu.contains(e.target) && e.target !== menuToggle){ if(navMenu.classList.contains('open')){ navMenu.classList.remove('open'); menuToggle.setAttribute('aria-expanded','false'); } } });
        })();
    }

        const API_KEY = '266fadd8dc914070b892d47f91163eeb';
        async function loadWishlist() {
            const container = document.getElementById('wishlistGrid');
            const userId = localStorage.getItem('currentUserId');

            // 1. Check if logged in
            if (!userId) {
                container.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px 20px; background: #1a1a1a; border-radius: 15px;">
                        <h3 style="color: #f5c518; margin-bottom: 15px;">Access Denied</h3>
                        <p style="color: #ccc; margin-bottom: 25px;">You must be logged in to view and manage your wishlist.</p>
                        <a href="signin.html" class="sign-in" style="padding: 10px 25px; text-decoration: none;">Go to Login</a>
                    </div>`;
                return;
            }

            try {
                const response = await fetch(`http://localhost:3000/wishlist/${userId}`);
                const data = await response.json();
                const wishlist = data.success ? data.data : [];

                if (wishlist.length === 0) {
                    container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px;">Your wishlist is empty. <a href="index.html" style="color: #f5c518;">Start adding games!</a></p>';
                    return;
                }

                container.innerHTML = '';

                // Fetch details for each game in wishlist
                for (const gameId of wishlist) {
                    const game = await fetchGameDetails(gameId);
                    if (game) {
                        displayWishlistGame(game, container);
                    }
                }
            } catch (error) {
                console.error('Error loading wishlist:', error);
                container.innerHTML = '<p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #ff6b6b;">Error loading wishlist. Please try again.</p>';
            }
        }

        // Updated updateAuthUI to show greeting
        function updateAuthUI() {
            const userEmail = localStorage.getItem('currentUser');
            const userName = localStorage.getItem('currentUserName') || 'Gamer';

            const authBtn = document.getElementById('authButtons');
            const userBtn = document.getElementById('userButtons');
            const greeting = document.getElementById('userGreeting');

            if (userEmail) {
                if(authBtn) authBtn.style.display = 'none';
                if(userBtn) userBtn.style.display = 'inline-flex'; 
                if(greeting) greeting.innerHTML = `Welcome, <span style="color: #f5c518; font-weight: bold;">${userName}</span>`;
            } else {
                if(authBtn) authBtn.style.display = 'inline';
                if(userBtn) userBtn.style.display = 'none';
            }
        }

        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('currentUserName');
                // Optional: Keep or clear wishlist on logout? Usually keep in localStorage.
                window.location.reload(); 
            }
        }

        function displayWishlistGame(game, container) {
            const gameCard = document.createElement('div');
            gameCard.className = 'game-card';
            gameCard.style.cursor = 'pointer';

            const backgroundImage = game.background_image ? `url(${game.background_image})` : 'linear-gradient(135deg, #f5c518 0%, #f50000 100%)';
            
            gameCard.innerHTML = `
                <div class="game-card-image" style="background-image: ${backgroundImage}; background-size: cover; background-position: center; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: flex-end; justify-content: space-between; padding: 10px; box-sizing: border-box;">
                    <button style="background-color: rgba(255,107,107,0.9); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 12px;" onclick="removeFromWishlist(${game.id}, event)">Remove</button>
                    <div style="background-color: rgba(0,0,0,0.7); width: 100%; padding: 8px; border-radius: 5px; text-align: center; cursor: pointer;" onclick="window.location.href='specific_game.html?id=${game.id}'">
                        <span class="logo-text" style="display: block; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${game.name}</span>
                        <span style="display: block; text-align: center; font-size: 12px; color: #f5c518;">⭐ ${game.rating}/5</span>
                    </div>
                </div>
            `;

            container.appendChild(gameCard);
        }

        async function removeFromWishlist(gameId, event) {
            event.stopPropagation();
            const userId = localStorage.getItem('currentUserId');
            if (!userId) return;

            try {
                const response = await fetch('http://localhost:3000/wishlist/remove', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gameId, userId })
                });
                if (response.ok) {
                    loadWishlist(); // Reload wishlist
                } else {
                    alert('Error removing game from wishlist');
                }
            } catch (error) {
                console.error('Error removing:', error);
                alert('Error removing game from wishlist');
            }
        }

        function handleSearch(event) {
            event.preventDefault();
            const query = document.getElementById('searchInput').value;
            if (query.trim()) {
                window.location.href = `searched_for.html?q=${encodeURIComponent(query)}`;
            }
        }

        document.addEventListener('DOMContentLoaded', loadWishlist);
    </script>
</body>
</html>
